#!/usr/bin/env bash

set -e
set -o pipefail

bin=`dirname "$0"`
bin=`cd "$bin">/dev/null; pwd`

export JOL_HOME=/opt/openjdk/code-tools/jol
export JOL_JAR=$JOL_HOME/jol-*/jol-cli/target/jol-externals.jar

setup() {
  if [ ! -e "$JOL_HOME" ]; then
    if [ "$(id -u)" != "0" ]; then
      echo "Creating $JOL_HOME; need to run as root"
      sudo mkdir -p "$JOL_HOME"
      sudo chmod a+rws "$JOL_HOME"
    else
      mkdir -p "$JOL_HOME"
    fi
  fi
  pushd "$JOL_HOME"
    local url='http://hg.openjdk.java.net/code-tools/jol/archive/tip.tar.gz'
    echo "At $JOL_HOME downloading $url"
    wget "$url"
    tar zxvf tip.tar.gz
    cd jol-*
    mvn clean install
  popd
}

main() {
  if [ ls $JOL_JAR 1> /dev/null 2> /dev/null ]; then
    echo "$JOL_JAR does not exist?"
    setup
  fi
  local jarfile=$(ls $JOL_JAR | head -n 1)
  java -jar "$jarfile" "$@"
}

main "$@"
